# 架构设计

本文档深入介绍 Vibe Coding 系统的架构、设计决策和组件交互。

## 目录

- [概述](#概述)
- [系统架构](#系统架构)
- [组件详解](#组件详解)
- [数据流](#数据流)
- [设计模式](#设计模式)
- [技术选型](#技术选型)

## 概述

Vibe Coding 是一个使用 AI 生成网页的微服务应用。系统由两个主要服务组成：

1. **API 服务** (Go) - 处理认证、项目管理和前端服务
2. **Agent 服务** (Node.js) - 使用 Claude Agent SDK 处理 AI 代码生成

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                            浏览器                              │
└───────────────────────────────┬─────────────────────────────────┘
                                │ HTTP/WebSocket
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         负载均衡器                           │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                ┌───────────────┴───────────────┐
                ▼                               ▼
┌──────────────────────────┐      ┌──────────────────────────┐
│      API 服务          │      │     Agent 服务         │
│      (Go / Hertz)        │◄────►│    (Node.js / Express)   │
│                          │      │                          │
│  - 路由                  │      │  - Claude Agent SDK      │
│  - 中间件                │      │  - SSE 流式传输          │
│  - 处理器                │      │  - 会话管理              │
│  - 服务层                │      │                          │
│  - DAO 层                │      │                          │
└────────┬─────────────────┘      └──────────────────────────┘
         │
    ┌────┴────────────────────────────┐
    ▼                                 ▼
┌─────────────────┐         ┌─────────────────┐
│  Redis 缓存    │         │  MySQL 数据库   │
│                 │         │                 │
│  - 会话数据     │         │  - 用户         │
│  - 热点数据     │         │  - 项目         │
│  - 速率限制     │         │  - 生成记录     │
└─────────────────┘         └─────────────────┘
```

## 组件详解

### API 服务 (Go)

**框架**: [CloudWeGo Hertz](https://github.com/cloudwego/hertz)

**核心组件**：

| 包 | 职责 |
|---------|----------------|
| `cmd/api` | 应用入口点 |
| `internal/router` | 路由定义和中间件设置 |
| `internal/handler` | HTTP 请求处理器 |
| `internal/service` | 业务逻辑层 |
| `internal/dao` | 数据访问层 |
| `internal/model` | 数据模型和结构体 |
| `internal/middleware` | 自定义中间件实现 |
| `pkg/` | 可复用包（缓存、数据库、日志等）|

### Agent 服务 (Node.js)

**框架**: Express.js with SSE support

**核心组件**：

| 模块 | 职责 |
|--------|----------------|
| `server.js` | Express 服务器设置 |
| `/api/generate` | 创建新的生成任务 |
| `/api/stream/:id` | 实时流式传输的 SSE 端点 |
| `/api/sessions` | 列出所有生成会话 |

### 数据库层

**MySQL Schema**：

```sql
users          -- 用户账户和认证数据
projects       -- 生成的网页项目
generations    -- AI 生成任务记录
sessions       -- 活跃会话存储
```

**缓存层 (Redis)**：

- 用户会话（JWT Token 黑名单）
- 速率限制计数器
- 热点数据缓存（三层缓存）

## 数据流

### 认证流程

```
用户 ──POST /api/v1/auth/login──► 路由器
                                    │
                                    ▼
                              中间件层
                                    │
                          ┌─────────┴─────────┐
                          ▼                   ▼
                    JWT 验证             速率限制
                          │                   │
                          └─────────┬─────────┘
                                    ▼
                              认证处理器
                                    │
                          ┌─────────┴─────────┐
                          ▼                   ▼
                    验证密码             生成 JWT
                          │                   │
                          └─────────┬─────────┘
                                    ▼
                              返回 Token
                                    │
                                    ▼
                                用户
```

### 代码生成流程

```
用户 ──POST /api/generate──► Agent 服务
                                │
                                ▼
                        创建会话 ID
                                │
                                ▼
                        返回会话 ID
                                │
                    ┌───────────┴───────────┐
                    ▼                       ▼
              用户连接到              Claude
              SSE /api/stream/:id    Agent SDK
                    │                       │
                    └───────────┬───────────┘
                                ▼
                        流式传输生成的
                        代码给用户
                                │
                                ▼
                            完成
```

## 设计模式

### 仓储模式

DAO 层实现了仓储模式，抽象数据库操作：

```go
type UserDAO interface {
    Create(ctx context.Context, user *model.User) error
    FindByID(ctx context.Context, id int64) (*model.User, error)
    FindByEmail(ctx context.Context, email string) (*model.User, error)
    Update(ctx context.Context, user *model.User) error
    Delete(ctx context.Context, id int64) error
}
```

### 中间件链模式

Hertz 使用中间件链处理横切关注点：

```
请求 → 恢复 → 请求ID → 访问日志 → CORS → 速率限制 → JWT → 处理器
```

### 三层缓存模式

```
请求 → L1 (本地缓存) → L2 (Redis) → L3 (MySQL) → 回填
           ↓ 未命中              ↓ 未命中
```

**特性**：
- 缓存穿透保护（布隆过滤器 + 空值缓存）
- 缓存击穿保护（Singleflight）
- 缓存雪崩保护（TTL 随机化）

### 依赖注入

服务通过构造函数接收依赖：

```go
type UserService struct {
    dao  dao.UserDAO
    cache cache.Cache
}

func NewUserService(dao dao.UserDAO, cache cache.Cache) *UserService {
    return &UserService{dao: dao, cache: cache}
}
```

## 技术选型

### 为什么选择 Go (Hertz)？

| 原因 | 描述 |
|--------|-------------|
| 性能 | 编译型语言，出色的并发支持 |
| 类型安全 | 编译时错误检测 |
| 生态系统 | 丰富的标准库和第三方包 |
| 部署 | 单个二进制文件，易于交叉编译 |
| Hertz | 字节跳动出品的高性能 HTTP 框架 |

### 为什么选择 Node.js (Agent 服务)？

| 原因 | 描述 |
|--------|-------------|
| Claude SDK | Claude Agent 的官方 Node.js SDK |
| 异步 I/O | 天然适合流式响应 |
| SSE 支持 | 对服务器发送事件的出色支持 |
| 开发效率 | AI 集成的快速迭代 |

### 为什么选择 MySQL？

| 原因 | 描述 |
|--------|-------------|
| 成熟度 | 经过实战验证的数据库 |
| ACID | 可靠的事务支持 |
| 生态系统 | 广泛的工具和专业知识 |
| GORM | 与 MySQL 配合出色的 Go ORM |

### 为什么选择 Redis？

| 原因 | 描述 |
|--------|-------------|
| 速度 | 内存操作 |
| 数据结构 | 丰富的数据类型 |
| 持久化 | 可选的磁盘持久化 |
| 生态系统 | 广泛使用且有完善的文档 |

## 安全架构

### 认证

```
┌─────────────┐
│   客户端    │
└──────┬──────┘
       │ POST /api/v1/auth/login
       ▼
┌─────────────────┐
│   验证          │
│   凭据          │
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌──────┐  ┌──────┐
│  DB  │  │bcrypt│
└───┬──┘  └───┬──┘
    │        │
    └────┬───┘
         ▼
    ┌─────────┐
    │  签发    │
    │   JWT   │
    └────┬────┘
         │
         ▼
    ┌─────────┐
    │ 返回    │
    │  Token  │
    └─────────┘
```

### 授权

- 基于 JWT 的无状态认证
- 基于角色的访问控制（未来）
- 路由级别的中间件保护

## 性能考虑

### 基准测试

测试环境：Apple M4 Pro / 16GB / macOS：

| 端点 | QPS | P99 延迟 |
|----------|-----|-------------|
| GET /ping | ~65,000 | 1.2ms |
| GET /api/v1/users | ~44,000 | 1.8ms |
| POST /api/v1/users | ~12,000 | 3.5ms |

### 优化策略

1. **连接池**：数据库连接复用
2. **缓存**：热点数据三层缓存
3. **速率限制**：防止滥用
4. **Singleflight**：合并并发请求
5. **响应压缩**：Gzip 中间件

## 未来架构考虑

### 潜在改进

- **消息队列**：异步任务处理
- **分布式追踪**：OpenTelemetry 实现
- **服务网格**：微服务通信
- **只读副本**：数据库扩展
- **CDN**：静态资源分发
- **WebSocket**：实时协作
- **Kubernetes**：编排和扩展

更多信息请参阅 [README](../README_zh.md) 和 [贡献指南](../CONTRIBUTING_zh.md)。
